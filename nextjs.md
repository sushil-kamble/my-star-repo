# Next Js

## Installation

`yarn create next-app`

## Environment Setup

- Create `.env.local`
- `SECRET_VARIABLES=sushil`

```jsx
import Head from "next/head";

// On Server
export function getServerSideProps() {
  console.log(process.env.SECRET_VARIABLES);
  return {
    props: {}
  };
}

// Server (SSR)  + Client (hydration)
export default function Home() {
  return (
    <div>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <h1>This is awesome</h1>
    </div>
  );
}
```

- Add this function in any one of the `Pages` files
- Environment variable will be available on `server` ie. that will be visible on the `terminal` but not on the client side even if we put it in page function.
- If we want to access variable on client side, then we have to add a prefix to variable like `NEXT_PUBLIC_` followed by variable name. Eg. `NEXT_PUBLIC_BROWSER_VARIABLE=something`. Now this variable will be available on `client`. ie. We can see it in browser console log.
- If we create 3 files `.env.development`, `.env.production`, `.env.local`. And we add a common variable to all three. like `SPECIFICITY_CHECK=<some_value>`. `<some_value>` is different for all three. Restart server and reload the page. `.env.local` value will be console logged. As `.evn.local` overrides the development value. If we dont have `.env.local` then `.env.development` will be console logged.
- ` console.log(process.env.NODE_ENV)` - will give output as `development` or `production`

```
.env.local - High security data, like database passwords, stripe keys, etc.

.env.development (Stripe client key)
.env.production
```

## getServerSideProps

- While building the application - `Mark SSR` - `sushil.me/abc-def` if `getServerSideProps` is present else `Mark Static`

- If `SSR` is marked then, whenever user visits the page `sushil.me/abc-def`. Firstly before anything `getServerSideProps` function will run.

- Following code is a dummy code for `next` server side rendering `ssr`. First server code will run, it will pass data to the page. Page will be built from the data and that page will be sent back to us.

```jsx
import Head from "next/head";

// Server
export async function getServerSideProps() {
  const db = await connectToDb();
  const rows = db.fetchRows();

  return {
    props: { rows }
  };
}

// Server (SSR)  + Client (hydration)
export default function Home(props) {
  const { rows } = props;
  return (
    <div>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <h1>{rows}</h1>
    </div>
  );
}
```

- [Visit Here for more info about server side rendering](https://nextjs.org/docs/basic-features/data-fetching#getserversideprops-server-side-rendering)

## Router

- The router will automatically route files named index to the root of the directory.

`pages/index.js` → `/`
`pages/blog/index.js` → `/blog`
`pages/blog/[slug].js` → `/blog/:slug` (/blog/hello-world)

- Here is an example to use the `slug` passed in the `url` in server function and on client.

```jsx
import { useRouter } from "next/router";

export function getServerSideProps(context) {
  console.log(context.query.slug);

  return {
    props: {}
  };
}

export default function Project() {
  const router = useRouter();
  const { slug } = router.query;

  return (
    <div>
      <h1>Post: {slug}</h1>
    </div>
  );
}
```

- If url is `http://localhost:3000/projects/hello-world?var1=10&var2=30` the query object will be `{ var1: '10', var2: '30', id: 'hello-world' }`. We can access it on server by `context.query` and on client by `router.query`

## [getStaticProps](https://nextjs.org/docs/basic-features/data-fetching#getstaticprops-static-generation)

- **Build pages on build time**
- **Very IMP**: If we have a `static route` then in `getStaticProps` function is enough
- **Very IMP**: But if we have `dynamic route` then along with `getStaticProps` and `getStaticPaths`.
- If you export an `async` function called `getStaticProps` from a page, Next.js will pre-render this page at `build time` using the `props` returned by `getStaticProps`.
- Visit [here](https://nextjs.org/docs/basic-features/data-fetching#getstaticprops-static-generation)

```jsx
export async function getStaticProps(context) {
  console.log("Open terminal to see me");
  return {
    props: {} // will be passed to the page component as props
  };
}
```

- **revalidate**

```jsx
export function getStaticProps(context) {
  return {
    props: { userCount: Math.random() },
    revalidate: 10 // Generate new page every 10 seconds - in production
    // But in development, it generates new page every time
  };
}

// Server (SSR)  + Client (hydration)
export default function Home(props) {
  return (
    <div>
      <h1>{props.userCount}</h1>
    </div>
  );
}
```

## [getStaticPaths](https://nextjs.org/docs/basic-features/data-fetching#getstaticpaths-static-generation)

- `getStaticPaths` is used along with `getStaticProps` in dynamic pages like `project/[id]`
- Build this pages at **BUILD TIME** (AHEAD OF TIME)

```jsx
import { useRouter } from "next/router";

export function getStaticProps(context) {
  return {
    props: {
      name: "Sushil"
    }
  };
}

export function getStaticPaths() {
  // Will build this pages at BUILD TIME (AHEAD OF TIME)
  return {
    fallback: false,
    paths: [
      { params: { id: "1" } },
      { params: { id: "2" } },
      { params: { id: "3" } }
    ]
  };
}

export default function Project(props) {
  const router = useRouter();

  return (
    <div>
      <h1>This is Page No: {router.query.id}</h1>
      <h2>Props passed from getStaticProps: {props.name}</h2>
    </div>
  );
}
```

**Fallback** - false

- If we request `products/4` -> **404: Page Not Found**

**Fallback** - true

- If we request `products/4` -> It calls `getStaticProps`. `getStaticProps` builds the new page for us.
- Page is returned even if `getStaticProps` has **not finished executing**
- Their is a slight delay in page content
- We can observe that

```jsx
export default function Project(props) {
  const router = useRouter();

  if (router.isFallback) {
    // getStaticProps is currently executing
    return <div>Loading...</div>;
  }

  return (
    <div>
      <h1>This is Page NO: {router.query.id}</h1>
      <h2>Props passed from getStaticProps: {props.name}</h2>
    </div>
  );
}
```

- If we are in `production` environment, and user request the page which was not requested before. Page will be build for that user and sent back to user (user will see some delay)
- That page will be `stored on disk` or `CDN` for other user.
- So other users will see that page `quickly`
- Remember `router.isFallback` will work as expected only in production

**Fallback** - blocking

- It will give same results will `fallback - true`, It blocks the rendering of page until `getStaticProps` has completed executing.
- Pros: No flashes of loading
- Cons: First visitor will have a little delay

> If we want to check that page is request or not. Open chrome dev tool's network tab and click on `fetch/XHR`

- For more info, visit [here](https://nextjs.org/docs/basic-features/data-fetching#getstaticpaths-static-generation)
